/**
 * @author  Samoylov Nikolay <samoylovnn [at] gmail [dt] com>
 * @weblog  http://blog.kplus.pro/
 * @project https://github.com/tarampampam/jquery.textmistake
 *
 * @version 0.1
 *
 * @licensy Licensed under the MIT, license text: http://goo.gl/JsVjCF
 *
 * @redactor Alexsandr Khramov <corpsepk [at] gmail [dt] com>
 */
(function(e){e.fn.textmistake=function(t){var n={l10n:{title:"Report a typo author:",urlHint:"Url of the page with error:",errTextHint:"Text with the error:",yourComment:"Your comment:",userComment:"Comment by user:",commentPlaceholder:"Type comment",cancel:"Cancel",send:"Send",mailSubject:"Typo on the site",mailTitle:"Typo on the site",mailSended:"Notification sent",mailSendedDesc:"Your notification has been sent successfully. Thank you for your feedback!",mailNotSended:"Sending error",mailNotSendedDesc:"Your message has not been sent, sorry."},debug:true,initCss:true,initHtml:true,overlayColor:"#666",overlayOpacity:.5,windowZindex:10001,hideBodyScroll:true,textLimit:400,contextLength:40,closeOnEsc:true,mailTo:"",mailFrom:"textmistake@"+window.location.hostname,mandrillKey:"",sendmailUrl:"",animateSpeed:0,autocloseTime:1e4,onShow:function(e){},onHide:function(e){},onLoadingShow:function(e){},onLoadingHide:function(e){},onCtrlEnter:function(){},onEscPressed:function(){},onSendMail:function(e){},onAjaxDone:function(e){},onAjaxResultError:function(e){},onAjaxSendError:function(e){}},r=e.extend({},n,t),i=function(e){if(r.debug){var t=(new Date).toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1");return console.log("["+t+"] "+e)}},s=e("html").first(),o=e("head").first(),u=e("body").first();if(r.initCss&&o.find("#mt_s").length===0)o.append('<style id="mt_s" type="text/css">        html.mistake-open,html.mistake-open body{            min-height:100%}        html.mistake-open body{            display:block;position:relative;overflow:hidden;top:0;left:0}        #mt_o{            position:fixed;padding:0;margin:0;top:0;left:0;width:100%;height:100%;            background:'+r.overlayColor+";z-index:"+r.windowZindex.toString()+";-moz-opacity:"+r.overlayOpacity.toString()+";opacity:"+r.overlayOpacity.toString()+";zoom:1;display:none}        #mt_c{            position:fixed;top:50%;left:50%;width:454px;height:auto;padding:30px 42px;            background:#fff;border:1px solid #777;outline:0;box-shadow:0 4px 16px rgba(0,0,0,.2);            font-family:Arial,sans-serif;font-size:13px;line-height:18px;            word-wrap:break-word;z-index:"+(r.windowZindex+1).toString()+";display:none}        #mt_c div.loading, #mt_c div.loading div.overlay{            position:absolute;top:0;left:0;width:100%;height:100%;}        #mt_c div.loading{            z-index:"+(r.windowZindex+2).toString()+";display:none        }        #mt_c div.loading div.overlay{            background:#666;-moz-opacity:0.1;opacity:0.1;        }        #mt_c div.loading div.spinner{            position:absolute;left:50%;top:50%;width:30px;height:30px;margin:-15px 0 0 -15px;background-color:#222;            -webkit-animation:rotateplane 1.2s infinite ease-in-out;            animation:rotateplane 1.2s infinite ease-in-out}                @-webkit-keyframes rotateplane                {0%{-webkit-transform:perspective(120px)}                50%{-webkit-transform:perspective(120px) rotateY(180deg)}                100%{-webkit-transform:perspective(120px) rotateY(180deg) rotateX(180deg)}}                @keyframes rotateplane                {0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}                50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg)}                100%{transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg);-webkit-transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg)}}        #mt_c .close{            position:absolute;right:0;top:0;margin:0;padding:17px;width:11px;height:11px;            background:url('https://i.imgur.com/U3EnhFo.png') no-repeat center center;            -moz-opacity:.7;opacity:.7;cursor:pointer;z-index:"+(r.windowZindex+10).toString()+"}        #mt_c .close:hover{            -moz-opacity:1;opacity:1}        #mt_c div.title{            height:32px;padding:0 0 0 40px;margin:0 0 16px;background-repeat:no-repeat;background-position:left center}        #mt_c div.title.feedback{            background-image:url('https://i.imgur.com/BCvESIh.png')}        #mt_c div.title.fire{            background-image:url('http://i.imgur.com/CHwbq2g.png')}        #mt_c div.title.mail{            background-image:url('http://i.imgur.com/Mo8R3H8.png')}        #mt_c div.title.star{            background-image:url('http://i.imgur.com/wgTKfJF.png')}        #mt_c div.title.cross{            background-image:url('http://i.imgur.com/5nx776T.png')}        #mt_c div.title h1{            color:#000;display:inline;font-family:Arial,sans-serif;font-size:16px;font-weight:400;line-height:32px}        #mt_c p{            margin:0 0 13px;padding:0}        #mt_c p.nowrap{            white-space:nowrap;overflow:hidden;position:relative}            #mt_c p.nowrap::after{                content:'';position:absolute;right:0;top:0;width:40px;height:100%;                background:-moz-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);                background:-webkit-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);                background:-o-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);                background:-ms-linear-gradient(left,rgba(255,255,255,0.2),#fff 100%);                background:linear-gradient(to right,rgba(255,255,255,0.2),#fff 100%)}        #mt_c p.nopadding{            margin:0;padding:0        }        #mt_c p .url{            color:#0f5bd9;text-decoration:underline}        #mt_c blockquote{            font-family:Arial,sans-serif;font-size:13px;line-height:18px;            padding:0;margin:6px 25px 20px 25px;background-image:none;background:transperent}        #mt_c blockquote strong{            font-weight:700;color:#d31;text-decoration:underline}        #mt_c input[type='text']{            width:100%;background-color:#fff;border:1px solid #d9d9d9;            border-radius:1px;box-sizing:border-box;font-size:13px;padding:3px 8px;            resize:none;text-align:start;word-wrap:break-word}            #mt_c input[type='text']:focus{                outline:0;border-color:#4d90fe}        #mt_c div.buttons{            margin:22px 0 0;text-align:right}        #mt_c input[type='button']{            background-color:#f5f5f5;background-image:-webkit-linear-gradient(top,#f5f5f5,#f1f1f1);            border-radius:2px;border:1px solid #e2e2e2;color:#444;            font-family:Arial,sans-serif;font-size:11px;font-weight:700;            height:29px;letter-spacing:normal;line-height:27px;            margin:0 0 0 16px;padding:0 15px;text-align:center;outline:0}            #mt_c input[type='button']:hover{                border-color:#d2d2d2}    </style>");if(r.initHtml&&u.find("#mt_c").length===0)u.append('<div id="mt_c">'+'<div class="loading"><div class="spinner"></div><div class="overlay"></div></div>'+'<div class="close mt_cl"></div>'+'<div class="title feedback"><h1>'+r.l10n.title+"</h1></div>"+'<p class="msg"></p>'+'<p class="nowrap">'+r.l10n.urlHint+' <span class="url"></span></p>'+'<p class="nopadding">'+r.l10n.errTextHint+"</p>"+"<blockquote></blockquote>"+"<p>"+r.l10n.yourComment+"</p>"+'<p><input type="text" maxlength="256" value="" placeholder="'+r.l10n.commentPlaceholder+'" /></p>'+'<div class="buttons">'+'<input type="button" class="mt_cl" value="'+r.l10n.cancel+'" />'+'<input type="button" class="mt_snd" value="'+r.l10n.send+'" />'+"</div>"+'</div><div id="mt_o"></div>');var a=u.find("#mt_o"),f=u.find("#mt_c"),l=f.find("div.loading").first(),c=f.find("div.title").first(),h=f.find("p.msg").first(),p=f.find("span.url").first(),d=f.find("blockquote").first(),v=f.find("input[type=text]").first(),m=f.find(".mt_cl"),g=f.find(".mt_snd"),y=null,b=function(){var e="";if(window.getSelection){e=window.getSelection().toString()}else if(document.selection&&document.selection.type!="Control"){e=document.selection.createRange().text}return e},w=function(e){var t,n,r,i="",s="";return"undefined"!=typeof window.getSelection?(t=window.getSelection(),t.rangeCount?n=t.getRangeAt(0):(n=document.createRange(),n.collapse(!0)),r=document.createRange(),r.selectNodeContents(e),r.setEnd(n.startContainer,n.startOffset),i=r.toString(),r.selectNodeContents(e),r.setStart(n.endContainer,n.endOffset),s=r.toString()):(t=document.selection)&&"Control"!=t.type&&(n=t.createRange(),r=document.body.createTextRange(),r.moveToElementText(e),r.setEndPoint("EndToStart",n),i=r.text,r.moveToElementText(e),r.setEndPoint("StartToEnd",n),s=r.text),{before:i,after:s}},E=function(e){var t={"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(e).replace(/[&<>"'\/]/g,function(e){return t[e]})},S=function(e){return e.replace(/\s+/g," ").replace(/[^a-zа-яё0-9\.\,\ \_\-\(\)\[\]\{\}\`\~\@\#\$\%\^\:\*]/gi,"")},x=function(){f.css({"margin-top":-(f.height()/2+parseInt(f.css("padding-top"))),"margin-left":-(f.width()/2+parseInt(f.css("padding-left")))})},T=function(t){if(typeof t==="boolean")if(t){if(e.isFunction(r.onLoadingShow))r.onLoadingShow(t);l.show().find("*").show()}else{if(e.isFunction(r.onLoadingHide))r.onLoadingHide(t);l.hide()}},N=function(t){if(typeof t==="boolean")if(t){if(e.isFunction(r.onShow))r.onShow(t);if(r.hideBodyScroll)s.addClass("mistake-open");f.find("*").show();c.removeClass().addClass("title feedback");h.html("").hide();l.hide();a.show(r.animateSpeed);x();f.show(r.animateSpeed);return true}else{if(e.isFunction(r.onHide))r.onHide(t);if(r.hideBodyScroll)s.removeClass("mistake-open");f.hide(r.animateSpeed);a.hide(r.animateSpeed);return false}return null},C=function(){return a.is(":visible")&&f.is(":visible")},k=function(e,t,n){if(!a.is(":visible"))a.show();f.find("*").hide();T(false);f.find("div.close").show();c.show().find("h1").html(e).show();if(n)c.removeClass().addClass("title "+n);h.html(t).show();x();if(r.autocloseTime>0){clearInterval(y);y=setInterval(function(){N(false);clearInterval(y)},r.autocloseTime)}if(!f.is(":visible"))f.show()},L=function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)},A=function(){if(!L(r.mailTo))return i('Email "'+r.mailTo+'" is not valid');if(!L(r.mailFrom))return i('Declare valid "Mail From" address');var t='<html lang="en"><head><meta charset="utf-8" /></head><body>'+"<h2>"+r.l10n.mailTitle+"</h2>"+"\n"+"<p><small>"+r.l10n.urlHint+" "+p.text()+"</small></p>"+"\n\n"+"<p>"+r.l10n.errTextHint+"</p>"+"\n"+"<blockquote>"+d.html()+"</blockquote>"+"\n\n";if(v.val())t+="<p>&nbsp;</p><p>"+r.l10n.userComment+"<br />"+"\n"+"<em>"+v.val()+"</em></p>";t+="</body></html>";var n="",s={key:"",message:{from_email:r.mailFrom,to:[{email:r.mailTo,type:"to"}],autotext:"true",subject:S(r.l10n.mailSubject),html:t,url:p.text(),comment:v.val(),textdata:d.html()}};if(r.sendmailUrl.length>0){s.key=r.mandrillKey;n=r.sendmailUrl}if(r.mandrillKey&&r.mandrillKey.length==22){s.key=r.mandrillKey;n="https://mandrillapp.com/api/1.0/messages/send.json"}if(n.length==0){k("Wrong settings","Check plugin settings","fire");return false}e.ajax({type:"POST",url:n,data:s}).done(function(t,n,s){if(e.isFunction(r.onAjaxDone))r.onAjaxDone(s);if(typeof s.status!=="undefined"&&s.status===200){if(e.isFunction(r.onSendMail))r.onSendMail(s);k(r.l10n.mailSended,r.l10n.mailSendedDesc,"star")}else{if(e.isFunction(r.onAjaxResultError))r.onAjaxResultError(s);k(r.l10n.mailNotSended,r.l10n.mailNotSendedDesc,"fire");i("Request was sended, but server answer is not valid")}}).error(function(t){if(e.isFunction(r.onAjaxSendError))r.onAjaxSendError(t);k(r.l10n.mailNotSended,r.l10n.mailNotSendedDesc,"fire");i('Ajax request error with status "'+t.status+'"')});T(true)};m.on("click",function(){N(false)});g.on("click",function(){A()});u.keydown(function(t){if(t.ctrlKey&&t.keyCode==13){if(e.isFunction(r.onCtrlEnter))r.onCtrlEnter();var n=w(document.body),s=S(n.before.slice(-r.contextLength)),o=S(n.after.slice(0,r.contextLength)),u=E(b()).replace(/(\r\n|\n|\r)/gm," ");if(u.length<1)return false;if(u.length>r.textLimit){i("Too many text");return false}v.val("");p.text(window.location);d.html("&hellip;"+s+"<strong>"+u+"</strong>"+o+"&hellip;");N(true)}});u.keyup(function(t){if(r.closeOnEsc&&C()&&t.keyCode==27){if(e.isFunction(r.onEscPressed))r.onEscPressed();N(false)}})}})(jQuery)